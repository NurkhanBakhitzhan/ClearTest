<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test Auth Client</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
  <form id="registerForm">
    <input type="text" name="username" placeholder="Username" required autocomplete="username" />
    <input type="email" name="email" placeholder="Email" required autocomplete="email" />
    <input type="password" name="password" placeholder="Password" required autocomplete="current-password" />
    <button type="submit">Register</button>
  </form>

  <h1>–í—Ö–æ–¥</h1>
  <form id="login-form">
    <input type="text" placeholder="Username" name="username" required><br>
    <input type="password" placeholder="Password" name="password" required><br>
    <button type="submit">–í–æ–π—Ç–∏</button>
  </form>

  <h1>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã</h1>
  <form id="create-room-form">
    <input type="text" name="roomName" placeholder="Room name" required />
    <select name="mode">
      <option value="public">Public</option>
      <option value="private">Private</option>
      <option value="protected">Protected (with password)</option>
    </select>
    <input type="password" name="password" placeholder="Password (optional)" />
    <button type="submit">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
  </form>

  <h1>–°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç</h1>
<button id="fetch-rooms">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
<ul id="room-list"></ul>



  <div id="log"></div>

  <script>
    const apiUrl = 'http://localhost:3001/api/auth';
    const socket = io('http://localhost:3001', {
      withCredentials: true
    });

    let userId = null;

    const log = (msg) => {
      const div = document.getElementById('log');
      div.innerHTML += `<p>${msg}</p>`;
    };

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = e.target.username.value;
      const email = e.target.email.value;
      const password = e.target.password.value;

      const response = await fetch(`${apiUrl}/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, email, password }),
      });

      const data = await response.json();
      console.log(data);
      log('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ' + JSON.stringify(data));
    });

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const res = await fetch(`${apiUrl}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          username: form.username.value,
          password: form.password.value
        })
      });
      const data = await res.json();
      localStorage.setItem('accessToken', data.accessToken);
      log('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
      
      const profile = await fetch(`${apiUrl}/profile`, {
        headers: {
          'Authorization': 'Bearer ' + data.accessToken
        }
      });
      const profileData = await profile.json();
      userId = profileData.id;
      log('userId: ' + userId);
    });

    document.getElementById('create-room-form').addEventListener('submit', (e) => {
      e.preventDefault();
      if (!userId) return log('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É');

      const name = e.target.roomName.value;
      const mode = e.target.mode.value;
      const password = e.target.password.value;

      socket.emit('createRoom', { name, mode, password, userId });
      log('üõ† –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã');
    });

    socket.on('roomCreated', ({ roomId }) => {
      log(`‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞. ID: ${roomId}`);
    });

    function getRooms() {
  socket.emit('getRooms');
}

socket.on('roomList', rooms => {
  const list = document.getElementById('roomList');
  list.innerHTML = '';

  rooms.forEach(room => {
    const li = document.createElement('li');
    li.innerHTML = `
      üè∞ <b>${room.name}</b> (${room.mode}) - –ò–≥—Ä–æ–∫–æ–≤: ${room.players.length}
      <button onclick="joinRoom('${room.id}', '${room.mode}')">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    `;
    list.appendChild(li);
  });
});

function joinRoom(roomId, mode) {
  if (!userId) return log('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏, —á—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è');

  let password = '';
  if (mode === 'protected') {
    password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:');
  }

  socket.emit('joinRoom', { roomId, userId, password });
  log(`‚è≥ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomId}`);
}

socket.on('roomJoined', ({ room, players }) => {
  log(`‚úÖ –ü–æ–¥–∫–ª—é—á—ë–Ω –∫ –∫–æ–º–Ω–∞—Ç–µ: ${room.name}`);
  displayPlayers(players, room.masterId);
});

socket.on('joinError', msg => {
  log('‚ùå –û—à–∏–±–∫–∞: ' + msg);
});

function displayPlayers(players, masterId) {
  const ul = document.createElement('ul');
  players.forEach(p => {
    const icon = (p.id === masterId) ? 'üëë' : 'üßç';
    const li = document.createElement('li');
    li.textContent = `${icon} ${p.name}`;
    ul.appendChild(li);
  });
  document.getElementById('log').appendChild(ul);
}

document.getElementById('fetch-rooms').addEventListener('click', async () => {
  const response = await fetch('http://localhost:3001/api/rooms')
  .then(res => res.json())
  .then(rooms => {
    if (!Array.isArray(rooms)) {
      console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', rooms);
      return;
    }
    rooms.forEach(room => {
      // —Ä–µ–Ω–¥–µ—Ä –∫–æ–º–Ω–∞—Ç—ã
    });
  })
  .catch(err => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–º–Ω–∞—Ç:', err));

  const rooms = await response.json();

  const list = document.getElementById('room-list');
  list.innerHTML = '';
  rooms.forEach(room => {
    const li = document.createElement('li');
    li.textContent = `${room.name} (ID: ${room.id})`;
    list.appendChild(li);
  });

  log(`üîÑ –ü–æ–ª—É—á–µ–Ω–æ ${rooms.length} –∫–æ–º–Ω–∞—Ç`);
});


  </script>
</body>
</html>
